services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
      args:
        GIT_COMMIT: ${GIT_COMMIT:-dev}
        BUILD_DATE: ${BUILD_DATE:-unknown}
        VERSION: ${VERSION:-1.0.0}
    container_name: vq8-profiler-api
    environment:
      # Application configuration
      WORK_DIR: ${WORK_DIR:-/data/work}
      OUTPUT_DIR: ${OUTPUT_DIR:-/data/outputs}
      MAX_SPILL_GB: ${MAX_SPILL_GB:-50}
      GAUSSIAN_TEST: ${GAUSSIAN_TEST:-dagostino}

      # Build metadata
      GIT_COMMIT: ${GIT_COMMIT:-dev}
      BUILD_DATE: ${BUILD_DATE:-unknown}
      VERSION: ${VERSION:-1.0.0}

      # API settings
      API_TITLE: "VQ8 Data Profiler API"
      API_VERSION: "1.0.0"
      CORS_ORIGINS: "http://localhost:4173,http://localhost:3000"

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: json
    volumes:
      - ./data:/data
    ports:
      - "8000:8000"
    networks:
      - profiler-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/healthz', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        GIT_COMMIT: ${GIT_COMMIT:-dev}
        BUILD_DATE: ${BUILD_DATE:-unknown}
        VERSION: ${VERSION:-1.0.0}
    container_name: vq8-profiler-web
    environment:
      # Build metadata
      VITE_GIT_COMMIT: ${GIT_COMMIT:-dev}
      VITE_BUILD_DATE: ${BUILD_DATE:-unknown}
      VITE_VERSION: ${VERSION:-1.0.0}

      # API endpoint
      VITE_API_URL: http://localhost:8000
    ports:
      - "4173:4173"
    networks:
      - profiler-network
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4173/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  profiler-network:
    driver: bridge
